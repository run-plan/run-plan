<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map_canvas { height: 100% }
    </style>

    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyA2IPbHZ-twbWgYkA6hZ6_nTwdTzsfNyFA&sensor=TRUE"></script>
    <script type="text/javascript">
    var map = null;
    var mylat = mylng = 0;
    var directionsDisplay;
    var directionsService = new google.maps.DirectionsService();
    var points = new Array();
    directionsDisplay = new google.maps.DirectionsRenderer({draggable: true});

    $(document).ready(function(){
        $("#setLocation").click(function(){ 
            $.ajax({
                type: "GET",
                //dataType: 'jsonp',
                url: "/search?api_key=AIzaSyCEabJeAlGcLRxfAbv3vhMhSEUjGvEWuj0&location=" + mylat + "," + mylng + "&radius=500",
                success: function(msg) {
                    var data = $.parseJSON(msg);
                    for ( var item in data.results ) {
                        var myPosition = new google.maps.LatLng(data.results[item].geometry.location.lat, data.results[item].geometry.location.lng);
                        var marker = new google.maps.Marker({
                            position: myPosition,
                            map: map,
                            title: data.results[item].name
                        });

                        google.maps.event.addListener(marker, 'click', function(clickData) {
                            directionsDisplay.setMap(map);
                            selectedLat= clickData.latLng.k;
                            selectedLng= clickData.latLng.D;
                            points.push({'location': new google.maps.LatLng(selectedLat, selectedLng), stopover:false} );
                            var request = {
                                origin: new google.maps.LatLng(mylat, mylng),
                                destination: new google.maps.LatLng(mylat, mylng),
                                waypoints: points,
                                travelMode: google.maps.TravelMode.WALKING,
                            };
                            directionsService.route(request, function(response, status) {
                                if (status == google.maps.DirectionsStatus.OK) {
                                    directionsDisplay.setDirections(response);
                                }
                            });    
                        });
                    }
                } 
            });
        });
        $('#clearRoute').click(function() {
            initialize();
        });
    });
    function initialize() {
        if (!navigator.geolocation) {
            document.write("Out!!");
            exit;
        }
        points = new Array();
        google.maps.event.addListener(directionsDisplay, 'directions_changed', function() {
                var total = 0;
                var myroute = directionsDisplay.directions.routes[0];
                for (i = 0; i < myroute.legs.length; i++) {
                    total += myroute.legs[i].distance.value;
                }
                total = total / 1000.
                console.log(total);
                $("#total").html(total + " km");
            });

        navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
        //watchPosition();
        function successCallback(position){
            mylat = position.coords.latitude;
            mylng = position.coords.longitude
            var mapOptions = {
                center: new google.maps.LatLng(position.coords.latitude, position.coords.longitude),
                zoom: 15,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
            var myPosition = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
            var marker = new google.maps.Marker({
                position: myPosition,
                map: map,
                title: "現在地"
            });

        }
        function errorCallback(error){
            var error_msg = "";
            switch(error.code){
                case 1:
                    error_msg = "位置情報の利用が許可されていません";
                    break;
                case 2:
                    error_msg = "デバイスの位置が判定できません";
                    break;
                case 3:
                    error_msg = "タイムアウトしました";
                    break;
            }
            console.log(error_msg);
        }
    }

    function watchPosition() {
        target = {
            latitude : 0,
            longitude: 0,
        }

        options = {
            enableHighAccuracy: false,
            timeout: 5000,
            maximumAge: 0
        }; 
        function successCallback(position){
              var crd = pos.coords;
              if (target.latitude === crd.latitude && target.longitude === crd.longitude) {
                  console.log('Congratulations, you reached the target');
                  navigator.geolocation.clearWatch(id);
              }
        }
        function errorCallback(error) {

        }

        //navigator.geolocation.watchPosition(success, error, options);
    }
    </script>
  </head>
  <body onload="initialize()">
    <div id="map_canvas" style="width:100%; height:100%"></div>
    <button id="setLocation">1kmRUN範囲指定</button>
    <button id="clearRoute">ルート削除</button>
    <div id="total"></div>
  </body>
</html>
